name: DIANA:DIAG - Connection diagnostics

on:
  workflow_dispatch:
  push:
    branches: [master]

jobs:
  diagnose:
    runs-on: ubuntu-latest

    steps:
    - name: 🔍 Ping server
      run: |
        if command -v ping; then ping -c 4 ${{ secrets.PROD_HOST }}; else echo "❌ ping not available"; fi

    - name: 🧪 Check port 22 (SSH)
      run: |
        if command -v nc; then nc -vz -w5 ${{ secrets.PROD_HOST }} 22 || echo "❌ Port 22 is unreachable"; else echo "❌ nc not available"; fi

    - name: 🌐 Curl HTTP (port 80)
      run: curl -I --max-time 5 http://${{ secrets.PROD_HOST }} || echo "❌ Port 80 not responding"

    - name: 🔒 Curl HTTPS (port 443)
      run: curl -I --max-time 5 https://${{ secrets.PROD_HOST }} || echo "❌ Port 443 not responding"

    - name: 🛰️ Optional: Traceroute
      run: |
        if command -v traceroute; then
          traceroute ${{ secrets.PROD_HOST }}
        else
          echo "⚠️ traceroute not installed"
        fi

    - name: ✅ Diagnostic completed
      run: echo "DIANA:DIAG completed. Check above for any ❌ indicators."
